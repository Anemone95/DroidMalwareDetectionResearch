#!/usr/bin/env python
#coding=utf-8

# @file merge.py
# @brief 读取多个csv文件，将数据填进Django model
# @author x565178035,x565178035@126.com
# @version 1.0
# @date 2017-12-11 11:36

from crawler import Paper
import os
# Django specific settings
import os
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "settings")
import django
django.setup()

# Import your models for use in your script
from db.models import *

papers=set()

def read_csv(filename):
    global papers
    with open(filename, 'r') as f:
        for each in f.readlines():
            split_res=each.rstrip().split(',')
            if len(split_res)<5:
                continue
            title=','.join(split_res[:-4])
            other=split_res[-4:]
            if other[-1] in ["2017","2016"]:
                other[-2]=other[-1]
            #  paper=Paper(title, *other)
            #  papers.add(paper)
            try:
                paper=Paper(
                        title=title,
                        inc_url=other[-4],
                        pdf_url=other[-3],
                        year=other[-2],
                        include=other[-1],
                        )
                paper.save()
                print "save:",title
            except Exception,e:
                pass

def merge():
    for dirpath, dirnames, filenames in os.walk('./csv'):
           for filename in filenames:
               read_csv( os.path.join(dirpath,filename) )
               #  print filename,len(papers)

def summary():
    includes=map(lambda e: e.include,papers)
    inc_summary={}
    for each in includes:
        if each not in inc_summary.keys():
            inc_summary[each]=1
        else:
            inc_summary[each]+=1

    sorted_list=sorted(inc_summary.iteritems(), key=lambda d:-d[1])

    for each in sorted_list:
        try:
            print "{0},{1}".format(each[0],each[1])
        except Exception:
            pass

if __name__ == '__main__':
    merge()
    #  summary()
    #  includes=filter(lambda e: e.include=="2017",papers)
    #  for each in includes:
        #  print each

    #  read_csv("./csv/Activesemisupervisedapproachforcheckingappbehavioragainstitsdescription.csv")
    #  print len(papers)

